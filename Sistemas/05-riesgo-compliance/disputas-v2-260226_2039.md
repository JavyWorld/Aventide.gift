### Sistema de Disputas v2.0 (Dispute Resolution + Saga determinística) — corregido y unificado

**Fuente de verdad:** “Disputas y Resolución (Saga) — ESPECIFICACIÓN FINAL”.

---

## 1) Definición y objetivos del sistema/módulo

**Definición:** Sistema que resuelve disputas **sin improvisación** usando:

- **Outcomes predefinidos** (plantillas) para que soporte no invente montos,

- Resolución por **buckets** (líneas contables) como única forma de mover dinero,

- **Platform Fee protegido** por _earned schedule_ (devengado por hitos) + override por culpa (fault),

- **ExternalCosts** (processing/chargeback/dispute fee) como bucket formal (nunca ignorado),

- Ejecución mediante **Saga idempotente** con auditoría WORM obligatoria.

**Objetivos:**

1. Determinismo financiero: mismo caso + mismo snapshot + misma policy ⇒ mismos buckets.

2. Compatibilidad multi-país: policies versionadas por país (sin romper histórico).

3. Contabilidad auditable: ledger append-only + evidencia WORM (paquete de disputa).

4. Seguridad operativa: workers async, idempotencia por step, dedupe en provider, no doble refund/release.

---

## 2) Alcance (incluye / excluye)

### Incluye

- Apertura y administración de `dispute_case` por orden.

- Catálogo de outcomes versionado por país.

- Cálculo de buckets desde `order_financial_snapshot` (inmutable) + policy.

- Earned schedule del Platform Fee por estado real en la línea de tiempo.

- Gestión de costos externos (processing/chargeback/dispute) con “External Cost Shield”.

- Orquestación Saga: refund, release/clawback, ledger adjustments, docs adjustments, trust/loyalty updates.

- Auditoría WORM del paquete de evidencia y del settlement plan.

### Excluye

- UI/Consola como producto (solo reglas y contratos).

- Reglas fiscales específicas de cada país (se delegan a Facturación & Documentos, invocadas por evento).

- Moderación/Trust como sistema completo (solo acciones disparadas por outcomes).

---

## 3) Actores y permisos (RBAC) + guards

### 3.1 Actores

- **BUYER / SELLER:** aportan evidencia y solicitan disputa.

- **SUPPORT L1:** abre y gestiona evidencia (no decide outcomes complejos).

- **SUPPORT L2:** selecciona outcome (sin montos).

- **COUNTRY_OPS_LEAD / L3:** casos críticos, overrides permitidos por policy (sin inventar montos).

- **FINANCE_REVIEWER:** aprobaciones para outcomes de alto impacto (policy-driven).

- **SYSTEM/BOT:** ejecuta saga, integra con provider, ledger, docs, trust, loyalty.

### 3.2 Permisos mínimos (namespaces)

- `disputes.open`

- `disputes.evidence.request/read/write`

- `disputes.outcome.select` (L2+)

- `disputes.outcome.compute` (system)

- `disputes.saga.execute` (system)

- `disputes.finance.approval.request` / `disputes.finance.approval.grant`

- `disputes.audit.read` (audit/finance/admin)

- `disputes.override.force_complete` (L3, solo si policy lo habilita)

### 3.3 Guards (orden canónico)

1. Auth

2. PermissionGuard

3. ScopeGuard (country_code en roles internos)

4. PolicyGuard (ventana de disputa, outcomes habilitados, thresholds, caps)

5. EvidenceGuard (solo muestra outcomes permitidos según evidencia/estado)

6. MoneyGuard (prohíbe montos manuales; solo inputs controlados: banda/items)

7. AuditGuard (razón obligatoria + append-only)

---

## 4) Flujos end-to-end (happy path + edge cases)

### 4.1 Apertura de disputa (DISPUTE_OPENED)

**Happy path**

1. Buyer/Seller/Support abre disputa (reason_code) sobre `order_id`.

2. Se bloquea la orden/escrow: **hold** (no payout/release) hasta resolución.

3. Se crea `dispute_case` y `dispute_events` (append-only).

**Edge cases**

- Ventana vencida: PolicyGuard bloquea apertura (o marca como “goodwill only” si policy lo permite).

- Disputa duplicada: lock por `order_id` evita 2 casos activos.

### 4.2 Recolección de evidencia

- Se pide evidencia a buyer/seller.

- Se adjunta PoD (Tridente: PIN+GPS+Foto) y logs relevantes al paquete.

### 4.3 Selección de outcome (OUTCOME_SELECTED)

**Regla dura:** soporte selecciona:

- `scenario_id`

- opcional `severity_band` (Minor/Major)

- opcional `affected_items[]`\
    y **nada más**.

La consola solo muestra outcomes permitidos por:

- estado real al momento de disputa,

- evidencia disponible,

- trust/riesgo (policy).

### 4.4 Cálculo determinístico (OUTCOME_COMPUTED)

- El sistema calcula buckets con:

    - `order_financial_snapshot` inmutable,

    - `policy_version` del país,

    - earned schedule según `state_at_dispute`,

    - `fault_attribution`.

Genera un `settlement_plan` idempotente (hash del input).

### 4.5 Ejecución Saga (steps idempotentes)

Steps exactos (orden canónico):

1. `DISPUTE_OPENED` (lock order_id)

2. `OUTCOME_SELECTED`

3. `OUTCOME_COMPUTED` (buckets + settlement_plan)

4. `EXECUTE_REFUND` (si aplica)

5. `EXECUTE_RELEASE/CLAWBACK` (si aplica)

6. `LEDGER_ADJUSTMENTS` (append-only)

7. `DOCS_ADJUSTMENTS` (async)

8. `TRUST_LOYALTY_UPDATES` (async)

9. `DISPUTE_RESOLVED`

**Edge cases críticos**

- Falla provider refund: step queda en RETRY/DLQ; no se duplica por idempotency key.

- Orden ya tenía payout parcial: Saga aplica _clawback/reserve_ según policy (si la plataforma soporta).

- Chargeback recibido: caso especial (ver OUT-G1) congela y prepara evidence packet; outcome final se decide después.

---

## 5) Reglas y políticas (límites, validaciones, caps, invariantes)

### 5.1 Snapshot financiero de la orden (SSOT)

Todo cálculo usa `order_financial_snapshot` con al menos:

- `items_subtotal`

- `seller_coupon_discount`

- `delivery_fee`

- `tax_amount`

- `platform_fee`

- `ops_fee`

- `processing_fee` (estimate/actual)

- `total_paid`

Derivados:

- `items_net = items_subtotal - seller_coupon_discount`

- `buyer_paid = total_paid`

- `seller_base_payable` (según modelo fiscal país)

### 5.2 Buckets (únicos “movimientos” permitidos)

Los únicos buckets que se pueden mover:

- `BuyerRefundCash`

- `BuyerCreditNonCash`

- `SellerPayoutRelease`

- `PlatformFeeKeep / PlatformFeeWaive`

- `OpsFeeKeep / OpsFeeWaive`

- `ExternalCosts`

**Regla dura:** soporte no edita montos; solo outcome template + inputs controlados.

### 5.3 Platform Fee protegido por devengado (earned schedule)

Policy default (configurable por país):

- `PAID_IN_ESCROW` → 20% earned

- `IN_PRODUCTION` → 50% earned

- `OUT_FOR_DELIVERY` → 80% earned

- `DELIVERED_VERIFIED` → 100% earned

Cálculo:

- `platform_fee_earned = platform_fee * earned_rate(state_at_dispute)`

- `platform_fee_unearned = platform_fee - platform_fee_earned`

### 5.4 Override por culpa (fault)

- `SELLER_FAULT` o `PLATFORM_FAULT` → por default se waivea incluso parte del earned (según policy).

- `BUYER_FAULT/FRAUD` con `DELIVERED_VERIFIED` + evidencia fuerte → permite keep casi completo.

- `FORCE_MAJEURE/UNKNOWN` → aplicar earned schedule neutral.

### 5.5 ExternalCosts + External Cost Shield

External costs por policy:

- `processing_fee_refundable` (true/false)

- `chargeback_fee` (monto fijo)

- `dispute_fee` (monto fijo)

Asignación recomendada:

- `SELLER_FAULT` → descuento de `SellerPayoutRelease` hasta cap.

- `BUYER_FAULT/FRAUD` → cubrir con Platform Fee kept / negar refund.

- `PLATFORM_FAULT` → plataforma absorbe (registrado).

- `FORCE_MAJEURE/UNKNOWN` → split neutral.

### 5.6 Fórmulas determinísticas (estándar)

Base:

- `refund_items = items_net * items_refund_pct`

- `refund_delivery = delivery_fee * delivery_refund_pct`

- `refund_tax = tax_amount * tax_refund_policy`

- `refund_platform_fee = platform_fee * platform_fee_refund_pct`

- `refund_total_cash = refund_items + refund_delivery + refund_tax + refund_platform_fee`

`platform_fee_refund_pct` estándar:

- SELLER_FAULT / PLATFORM_FAULT → 100% (default)

- BUYER_FAULT/FRAUD + delivered_verified → 0%

- FORCE_MAJEURE/UNKNOWN → `platform_fee_unearned / platform_fee`

Seller release:

- `seller_release = seller_base_payable - refund_items_adjustment - external_costs_assigned_to_seller`

- Nunca negativo; si <0 → `seller_negative_balance` o compensa con reserve futura (según policy).

### 5.7 Invariantes finales (leyes)

- Soporte nunca introduce montos manuales.

- Platform Fee se protege por devengado + culpa + evidencia (no % fijo).

- ExternalCosts siempre existen como bucket formal.

- Ejecución siempre Saga idempotente.

- Todo queda auditable + WORM.

---

## 6) Modelo de datos (tablas/colecciones, campos, índices, relaciones)

### 6.1 dispute_cases

- `case_id` (UUID)

- `order_id` (unique activo)

- `opened_by` (BUYER|SELLER|SYSTEM|SUPPORT)

- `reason_code`

- `fault_attribution` (SELLER_FAULT|BUYER_FAULT|PLATFORM_FAULT|FORCE_MAJEURE|UNKNOWN)

- `evidence_level` (NONE|WEAK|STRONG) + refs (PoD packet, attachments)

- `status` (state machine)

- `country_code`

- timestamps (`opened_at`, `resolved_at`)

Índices:

- unique parcial: `(order_id) WHERE status IN (OPEN,UNDER_REVIEW,EXECUTING)`

- `(country_code, status, opened_at)`

### 6.2 dispute_outcomes (selección + cálculo)

- `case_id`

- `template_id`

- `inputs` JSON (severity_band, affected_items)

- `policy_version`

- `computed_payload` JSON (buckets + derived numbers)

- `settlement_plan_id`

- `computed_at`, `executed_at`

### 6.3 dispute_events (append-only)

- `event_id`

- `case_id`

- `event_type` (OPENED|EVIDENCE_REQUESTED|EVIDENCE_RECEIVED|OUTCOME_SELECTED|OUTCOME_COMPUTED|SAGA_STEP\_\*|RESOLVED)

- `actor_id`, `actor_role`

- `ts_utc`

- `metadata` JSON

- `trace_id`, `request_id`

### 6.4 dispute_outcomes_catalog (plantillas versionadas)

- `template_id`

- `country_code`

- `scenario_id`

- `conditions` (estado mínimo, evidencia requerida, trust gates)

- `allowed_inputs_schema` (band/items)

- `bucket_formula_ref`

- `actions_ref` (docs/trust/loyalty)

- `enabled`

- `version`, `valid_from/to`

### 6.5 settlement_plans (idempotentes)

- `settlement_plan_id`

- `case_id`

- `input_hash` (hash(snapshot + policy_version + template + inputs + fault + state_at_dispute))

- `buckets` JSON (resultado final)

- `idempotency_keys` JSON (refund/release/ledger/docs/trust)

- `status`

---

## 7) Eventos y triggers (event bus/colas/webhooks) + idempotencia

### 7.1 Eventos del dominio Disputas

- `DISPUTE_OPENED`

- `DISPUTE_EVIDENCE_REQUESTED/RECEIVED`

- `DISPUTE_OUTCOME_SELECTED`

- `DISPUTE_OUTCOME_COMPUTED`

- `DISPUTE_SAGA_STEP_*`

- `DISPUTE_RESOLVED`

- `CHARGEBACK_RECEIVED`

### 7.2 Idempotencia por step (claves obligatorias)

- Refund: `refund:{order_id}:{case_id}:{attempt}`

- Release/Clawback: `release:{order_id}:{case_id}`

- Ledger: `ledger:{order_id}:{case_id}:{step}`

- Docs: `docs_adjust:{order_id}:{case_id}`

- Trust/Loyalty: `trust_loyalty:{order_id}:{case_id}`

---

## 8) Integraciones (inputs/outputs, retries, timeouts, fallbacks)

### 8.1 Órdenes

- Input: `state_at_dispute` + timeline.

- Output: flags/estados (ej. `DISPUTED`) y bloqueo de acciones sensibles.

### 8.2 Pagos/Escrow/Provider

- Refunds parciales/totales.

- Release/hold/clawback.

- Chargebacks: congelar + preparar evidence packet.

### 8.3 Ledger

- Posteo de ajustes append-only y conciliables.

### 8.4 Facturación & Documentos

- Credit notes/anulación/reemplazo por país tras `DOCS_ADJUSTMENTS`.

### 8.5 Trust & Loyalty

- Strikes/penalizaciones por fault.

- Reversión de recompensas/loyalty si hay refund/chargeback.

---

## 9) Observabilidad (logs, métricas, alertas, SLOs) — aplicado a Disputas

### Métricas mínimas

- `disputes_opened_total{country,reason}`

- `disputes_resolved_total{country,outcome}`

- `disputes_time_to_resolve_seconds_p95{country}`

- `disputes_saga_step_failed_total{step,provider}`

- `refund_success_rate{country,provider}`

- `external_costs_total{country,type}`

- `chargebacks_total{country}`

### Alertas mínimas

- Saga lag alto (outcome_selected → resolved)

- Step refund/release fallando (provider degradado)

- Spike chargebacks por país/método

---

## 10) Seguridad y auditoría (quién hizo qué, evidencia, retención)

### 10.1 Paquete WORM obligatorio

Guardar en WORM:

- snapshot financiero,

- outcome template + policy_version,

- settlement plan calculado,

- evidencias (PoD packet + logs relevantes),

- ledger entries finales,

- docs fiscales emitidos/credit notes.

### 10.2 Audit log append-only

- Quién seleccionó outcome, razón, notas internas, timestamps, hashes.

---

## 11) Compatibilidad con sistemas existentes (dependencias directas)

- **Seguridad:** Tridente, idempotencia, workers async.

- **Pagos:** escrow, refunds, external fees, chargebacks.

- **Soporte:** consola solo muestra outcomes permitidos; sin montos manuales.

- **Facturación & Documentos:** credit notes/anulación/reemplazo tras resolución.

- **Ledger/Auditoría:** append-only + WORM, conciliable.

---

### Conflictos/incoherencias corregidas (dentro de Disputas)

1. “Montos manuales” → eliminado: solo templates + inputs controlados.

2. Platform Fee “sagrado % fijo” → eliminado: earned schedule + fault + evidencia.

3. Costos externos ignorados → eliminado: `ExternalCosts` bucket + shield.

4. Ejecución frágil → eliminado: Saga idempotente por step + DLQ/retries.

5. Falta de forensia → eliminado: WORM packet con snapshot+evidencias+ledger+docs.